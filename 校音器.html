<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ¡éŸ³å™¨</title>
    <!-- æ–°å¢ï¼šç½‘ç«™æ ‡ç­¾é¡µè¡¨æƒ…åŒ…logoï¼ŒéŸ³ç¬¦emojiæ¸…æ™°ä½“ç°æ ¡éŸ³å™¨å±æ€§ -->
  <link
    rel="icon"
    href="https://user-assets.sxlcdn.com/images/1209238/FlWuslNmGTHt1EipxUtq2GI6zqnN.png?imageMogr2/strip/auto-orient/thumbnail/1200x9000%3E/quality/90!/format/png"
    type="image/png"
  />
    <style>
        /* å…¨å±€ä¸»é¢˜å˜é‡ */
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-green: #27ae60;
            --accent-yellow: #f39c12;
            --accent-red: #e74c3c;
            --accent-primary: #3498db;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #f5f5f5;
            --text-secondary: #b0b0b0;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-red: #e74c3c;
            --accent-primary: #3498db;
            --border-color: #333333;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        /* å¤´éƒ¨æ ·å¼ */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 24px;
            font-weight: 700;
        }
        .header-buttons {
            display: flex;
            gap: 12px;
        }
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            transition: transform 0.2s, background-color 0.2s;
        }
        .icon-btn:hover {
            transform: scale(1.05);
            background-color: var(--accent-primary);
            color: white;
        }
        /* ä¸»æ˜¾ç¤ºåŒºåŸŸ */
        .main-display {
            background-color: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        .status-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .mic-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .mic-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent-red);
        }
        .mic-indicator.active {
            background-color: var(--accent-green);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .volume-bar {
            width: 100px;
            height: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }
        .volume-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-yellow), var(--accent-red));
            transition: width 0.1s;
        }
        .note-display {
            text-align: center;
        }
        .note-name {
            font-size: 120px;
            font-weight: 900;
            line-height: 1;
            color: var(--text-primary);
            transition: color 0.2s;
        }
        .note-name.in-tune {
            color: var(--accent-green);
        }
        .note-details {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 12px;
            font-size: 18px;
            color: var(--text-secondary);
        }
        .octave {
            font-size: 24px;
            font-weight: 600;
        }
        .cents-display {
            font-size: 32px;
            font-weight: 700;
            transition: color 0.2s;
        }
        .cents-display.plus {
            color: var(--accent-red);
        }
        .cents-display.minus {
            color: var(--accent-primary);
        }
        .cents-display.in-tune {
            color: var(--accent-green);
        }
        /* è°ƒéŸ³è¡¨ç”»å¸ƒ */
        .meter-container {
            width: 100%;
            max-width: 500px;
            position: relative;
        }
        #meterCanvas {
            width: 100%;
            height: auto;
            display: block;
        }
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .main-control {
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        .primary-btn {
            padding: 14px 32px;
            border-radius: 50px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: var(--shadow);
        }
        .start-btn {
            background-color: var(--accent-green);
            color: white;
        }
        .start-btn:hover {
            transform: scale(1.05);
            background-color: #219653;
        }
        .stop-btn {
            background-color: var(--accent-red);
            color: white;
        }
        .stop-btn:hover {
            transform: scale(1.05);
            background-color: #c0392b;
        }
        .a4-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }
        .a4-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .a4-slider {
            flex: 1;
            min-width: 200px;
            height: 6px;
            border-radius: 3px;
            background-color: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }
        .a4-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--accent-primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .a4-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--accent-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .a4-input {
            width: 80px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }
        /* ä¹å™¨é¢„è®¾åŒºåŸŸ */
        .preset-panel {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .preset-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        .preset-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preset-btn:hover, .preset-btn.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        /* æ³¢å½¢å¯è§†åŒ–åŒºåŸŸ */
        .waveform-container {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .waveform-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        #waveformCanvas {
            width: 100%;
            height: 100px;
            display: block;
            border-radius: 8px;
            background-color: var(--bg-primary);
        }
        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 400px;
            height: 100vh;
            background-color: var(--bg-secondary);
            box-shadow: -4px 0 12px rgba(0,0,0,0.2);
            padding: 24px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }
        .settings-panel.open {
            transform: translateX(0);
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .settings-title {
            font-size: 22px;
            font-weight: 700;
        }
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }
        .setting-label {
            font-size: 16px;
            font-weight: 500;
            flex-shrink: 0;
        }
        /* æ–°å¢ï¼šé™éŸ³é˜ˆå€¼æ˜¾ç¤ºæ–‡æœ¬æ ·å¼ */
        .threshold-display {
            font-size: 14px;
            color: var(--text-secondary);
            min-width: 160px;
            text-align: right;
            flex-shrink: 0;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: 0.3s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-primary);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.open {
            display: block;
        }
        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            background-color: var(--accent-red);
            color: white;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.success {
            background-color: var(--accent-green);
        }
        .toast.warning {
            background-color: var(--accent-yellow);
        }
        /* å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            h1 {
                font-size: 20px;
            }
            .note-name {
                font-size: 90px;
            }
            .preset-buttons {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            .a4-control {
                flex-direction: column;
                align-items: stretch;
            }
            .note-details {
                font-size: 16px;
            }
            .cents-display {
                font-size: 28px;
            }
            .setting-item {
                flex-wrap: wrap;
            }
            .threshold-display {
                width: 100%;
                text-align: right;
                margin-top: -8px;
            }
        }
        @media (max-width: 480px) {
            .note-name {
                font-size: 70px;
            }
            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="toast" id="toast"></div>
    <div class="container">
        <header>
            <h1>ä¸“ä¸šåœ¨çº¿æ ¡éŸ³å™¨</h1>
            <div class="header-buttons">
                <button class="icon-btn" id="themeBtn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                <button class="icon-btn" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
            </div>
        </header>
        <div class="main-display">
            <div class="status-bar">
                <div class="mic-status">
                    <div class="mic-indicator" id="micIndicator"></div>
                    <span id="micStatusText">æœªå¯åŠ¨</span>
                </div>
                <div class="volume-bar">
                    <div class="volume-fill" id="volumeFill"></div>
                </div>
            </div>
            <div class="note-display">
                <div class="note-name" id="noteName">â€”</div>
                <div class="note-details">
                    <div class="octave" id="octave">å…«åº¦: â€”</div>
                    <div class="cents-display" id="centsDisplay">0éŸ³åˆ†</div>
                </div>
            </div>
            <div class="meter-container">
                <canvas id="meterCanvas" width="500" height="250"></canvas>
            </div>
        </div>
        <div class="control-panel">
            <div class="main-control">
                <button class="primary-btn start-btn" id="startBtn">å¼€å§‹æ ¡éŸ³</button>
            </div>
            <div class="a4-control">
                <label class="a4-label">A4å‚è€ƒé¢‘ç‡</label>
                <input type="range" min="430" max="450" step="0.1" value="440" class="a4-slider" id="a4Slider">
                <input type="number" min="430" max="450" step="0.1" value="440" class="a4-input" id="a4Input">
                <span>Hz</span>
            </div>
        </div>
        <div class="preset-panel">
            <div class="preset-title">ä¹å™¨è°ƒéŸ³é¢„è®¾</div>
            <div class="preset-buttons">
                <button class="preset-btn active" data-preset="all">å…¨éŸ³åŸŸ</button>
                <button class="preset-btn" data-preset="guitar">å‰ä»–(æ ‡å‡†)</button>
                <button class="preset-btn" data-preset="ukulele">å°¤å…‹é‡Œé‡Œ</button>
                <button class="preset-btn" data-preset="violin">å°æç´</button>
                <button class="preset-btn" data-preset="bass">è´æ–¯(4å¼¦)</button>
                <button class="preset-btn" data-preset="piano">é’¢ç´</button>
            </div>
        </div>
        <div class="waveform-container">
            <div class="waveform-title">éŸ³é¢‘æ³¢å½¢</div>
            <canvas id="waveformCanvas" width="800" height="100"></canvas>
        </div>
    </div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">è®¾ç½®</h2>
            <button class="close-btn" id="closeSettingsBtn">âœ•</button>
        </div>
        <div class="setting-item">
            <span class="setting-label">æ·±è‰²æ¨¡å¼</span>
            <label class="toggle-switch">
                <input type="checkbox" id="themeToggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <div class="setting-item">
            <span class="setting-label">æ£€æµ‹å¹³æ»‘åº¦</span>
            <input type="range" min="1" max="10" value="5" class="a4-slider" id="smoothSlider">
        </div>
        <!-- ä¿®æ”¹ï¼šé™éŸ³é˜ˆå€¼æ»‘å—minæ”¹ä¸º0ï¼Œæ–°å¢å®æ—¶æ˜¾ç¤ºå…ƒç´  -->
        <div class="setting-item">
            <span class="setting-label">é™éŸ³é˜ˆå€¼</span>
            <input type="range" min="0" max="0.05" step="0.001" value="0.01" class="a4-slider" id="thresholdSlider">
            <span class="threshold-display" id="thresholdDisplay">å±è”½ä½äº -40dB çš„å£°éŸ³</span>
        </div>
    </div>
    <script>
        // å…¨å±€é…ç½®å˜é‡
        let audioContext;
        let analyser;
        let mediaStreamSource;
        let isRunning = false;
        let animationFrameId;
        let a4Frequency = 440;
        let currentPreset = 'all';
        let smoothLevel = 5;
        let silenceThreshold = 0.01;
        let recentFrequencies = [];
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        // ä¹å™¨è°ƒéŸ³é¢„è®¾ (å¯¹åº”MIDIç¼–å·)
        const presets = {
            all: null,
            guitar: [40, 45, 50, 55, 59, 64], // E2 A2 D3 G3 B3 E4 æ ‡å‡†å‰ä»–è°ƒå¼¦
            ukulele: [55, 60, 64, 69], // G4 C4 E4 A4 å°¤å…‹é‡Œé‡Œæ ‡å‡†è°ƒå¼¦
            violin: [55, 62, 69, 76], // G3 D4 A4 E5 å°æç´æ ‡å‡†è°ƒå¼¦
            bass: [28, 33, 38, 43], // E1 A1 D2 G2 å››å¼¦è´æ–¯æ ‡å‡†è°ƒå¼¦
            piano: null
        };
        // DOMå…ƒç´ è·å–
        const startBtn = document.getElementById('startBtn');
        const micIndicator = document.getElementById('micIndicator');
        const micStatusText = document.getElementById('micStatusText');
        const volumeFill = document.getElementById('volumeFill');
        const noteNameEl = document.getElementById('noteName');
        const octaveEl = document.getElementById('octave');
        const centsDisplayEl = document.getElementById('centsDisplay');
        const meterCanvas = document.getElementById('meterCanvas');
        const waveformCanvas = document.getElementById('waveformCanvas');
        const a4Slider = document.getElementById('a4Slider');
        const a4Input = document.getElementById('a4Input');
        const presetBtns = document.querySelectorAll('.preset-btn');
        const settingsBtn = document.getElementById('settingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const overlay = document.getElementById('overlay');
        const themeBtn = document.getElementById('themeBtn');
        const themeToggle = document.getElementById('themeToggle');
        const smoothSlider = document.getElementById('smoothSlider');
        const thresholdSlider = document.getElementById('thresholdSlider');
        const thresholdDisplay = document.getElementById('thresholdDisplay');
        const toast = document.getElementById('toast');
        // Canvasä¸Šä¸‹æ–‡åˆå§‹åŒ–
        const meterCtx = meterCanvas.getContext('2d');
        const waveformCtx = waveformCanvas.getContext('2d');

        // æ–°å¢ï¼šRMSçº¿æ€§å€¼è½¬åˆ†è´å€¼å·¥å…·å‡½æ•°
        function rmsToDb(rms) {
            if (rms <= 0) return '-âˆ';
            return Math.round(20 * Math.log10(rms));
        }

        // åˆå§‹åŒ–è°ƒéŸ³è¡¨åˆ»åº¦
        function initMeter() {
            const width = meterCanvas.width;
            const height = meterCanvas.height;
            const centerX = width / 2;
            const centerY = height;
            const radius = width * 0.9;
            // æ¸…ç©ºç”»å¸ƒ
            meterCtx.clearRect(0, 0, width, height);
            // ç»˜åˆ¶èƒŒæ™¯å¼§
            meterCtx.beginPath();
            meterCtx.arc(centerX, centerY, radius, Math.PI, 0);
            meterCtx.lineWidth = 10;
            meterCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            meterCtx.lineCap = 'round';
            meterCtx.stroke();
            // ç»˜åˆ¶åˆ»åº¦çº¿ä¸æ ‡ç­¾
            meterCtx.lineWidth = 2;
            meterCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            meterCtx.font = '14px sans-serif';
            meterCtx.textAlign = 'center';
            meterCtx.textBaseline = 'top';
            for (let i = -50; i <= 50; i += 10) {
                const angle = Math.PI + (Math.PI * (i + 50) / 100);
                const isMajor = i % 50 === 0;
                const lineLength = isMajor ? 20 : 10;
                const startX = centerX + Math.cos(angle) * (radius - lineLength);
                const startY = centerY + Math.sin(angle) * (radius - lineLength);
                const endX = centerX + Math.cos(angle) * radius;
                const endY = centerY + Math.sin(angle) * radius;
                meterCtx.beginPath();
                meterCtx.moveTo(startX, startY);
                meterCtx.lineTo(endX, endY);
                meterCtx.stroke();
                // ç»˜åˆ¶éŸ³åˆ†æ ‡ç­¾
                if (i % 10 === 0) {
                    const labelX = centerX + Math.cos(angle) * (radius + 20);
                    const labelY = centerY + Math.sin(angle) * (radius + 20);
                    meterCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
                    meterCtx.fillText(i, labelX, labelY);
                }
            }
            // ç»˜åˆ¶æŒ‡é’ˆåº•åº§
            meterCtx.beginPath();
            meterCtx.arc(centerX, centerY, 15, Math.PI, 0);
            meterCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            meterCtx.fill();
        }
        // ç»˜åˆ¶è°ƒéŸ³è¡¨æŒ‡é’ˆ
        function drawPointer(cents) {
            const width = meterCanvas.width;
            const height = meterCanvas.height;
            const centerX = width / 2;
            const centerY = height;
            const radius = width * 0.9;
            // é‡ç»˜èƒŒæ™¯åˆ»åº¦
            initMeter();
            // é™åˆ¶éŸ³åˆ†èŒƒå›´åœ¨Â±50
            const clampedCents = Math.max(-50, Math.min(50, cents));
            const angle = Math.PI + (Math.PI * (clampedCents + 50) / 100);
            // æŒ‡é’ˆé¢œè‰²è§„åˆ™
            let pointerColor;
            if (Math.abs(clampedCents) <= 5) {
                pointerColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-green');
            } else if (Math.abs(clampedCents) <= 15) {
                pointerColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-yellow');
            } else {
                pointerColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-red');
            }
            // ç»˜åˆ¶æŒ‡é’ˆ
            meterCtx.beginPath();
            meterCtx.moveTo(centerX, centerY);
            meterCtx.lineTo(
                centerX + Math.cos(angle) * (radius - 25),
                centerY + Math.sin(angle) * (radius - 25)
            );
            meterCtx.lineWidth = 4;
            meterCtx.strokeStyle = pointerColor;
            meterCtx.lineCap = 'round';
            meterCtx.stroke();
            // é‡ç»˜æŒ‡é’ˆåº•åº§
            meterCtx.beginPath();
            meterCtx.arc(centerX, centerY, 15, Math.PI, 0);
            meterCtx.fillStyle = pointerColor;
            meterCtx.fill();
        }
        // ç»˜åˆ¶å®æ—¶æ³¢å½¢
        function drawWaveform(dataArray) {
            const width = waveformCanvas.width;
            const height = waveformCanvas.height;
            waveformCtx.clearRect(0, 0, width, height);
            waveformCtx.lineWidth = 2;
            waveformCtx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
            waveformCtx.beginPath();
            const sliceWidth = width / dataArray.length;
            let x = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * height / 2;
                if (i === 0) {
                    waveformCtx.moveTo(x, y);
                } else {
                    waveformCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            waveformCtx.lineTo(width, height / 2);
            waveformCtx.stroke();
        }
        // YINé«˜ç²¾åº¦éŸ³é«˜æ£€æµ‹ç®—æ³•
        function yinPitchDetect(buffer, sampleRate) {
            const bufferSize = buffer.length;
            const yinBuffer = new Float32Array(bufferSize / 2);
            const threshold = 0.1;
            let probability = 0;
            let tau;
            // æ­¥éª¤1: è®¡ç®—å·®å€¼å‡½æ•°
            for (let t = 1; t < yinBuffer.length; t++) {
                yinBuffer[t] = 0;
                for (let i = 0; i < yinBuffer.length; i++) {
                    const delta = buffer[i] - buffer[i + t];
                    yinBuffer[t] += delta * delta;
                }
            }
            // æ­¥éª¤2: ç´¯è®¡å‡å€¼å½’ä¸€åŒ–
            yinBuffer[0] = 1;
            let runningSum = 0;
            for (let t = 1; t < yinBuffer.length; t++) {
                runningSum += yinBuffer[t];
                yinBuffer[t] *= t / runningSum;
            }
            // æ­¥éª¤3: ç»å¯¹é˜ˆå€¼æ£€æµ‹
            for (tau = 2; tau < yinBuffer.length; tau++) {
                if (yinBuffer[tau] < threshold) {
                    while (tau + 1 < yinBuffer.length && yinBuffer[tau + 1] < yinBuffer[tau]) {
                        tau++;
                    }
                    probability = 1 - yinBuffer[tau];
                    break;
                }
            }
            // æ— æœ‰æ•ˆéŸ³é«˜è¿”å›
            if (tau === yinBuffer.length || yinBuffer[tau] >= threshold) {
                return null;
            }
            // æ­¥éª¤4: æŠ›ç‰©çº¿æ’å€¼æå‡ç²¾åº¦
            const x1 = yinBuffer[tau - 1];
            const x2 = yinBuffer[tau];
            const x3 = yinBuffer[tau + 1];
            const a = (x1 + x3 - 2 * x2) / 2;
            const b = (x3 - x1) / 2;
            if (a) tau -= b / (2 * a);
            // è½¬æ¢ä¸ºé¢‘ç‡
            const frequency = sampleRate / tau;
            // æ¦‚ç‡ä¸é¢‘ç‡èŒƒå›´è¿‡æ»¤
            if (probability < 0.9 || frequency < 20 || frequency > 5000) {
                return null;
            }
            return frequency;
        }
        // é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦ä¿¡æ¯
        function frequencyToNote(frequency, a4) {
            if (!frequency || frequency <= 0) return null;
            // åäºŒå¹³å‡å¾‹è®¡ç®—MIDIç¼–å·
            const midiNote = 69 + 12 * Math.log2(frequency / a4);
            const roundedMidi = Math.round(midiNote);
            const cents = Math.round((midiNote - roundedMidi) * 100);
            // è®¡ç®—éŸ³åä¸å…«åº¦
            const noteIndex = roundedMidi % 12;
            const octave = Math.floor(roundedMidi / 12) - 1;
            const noteName = noteNames[noteIndex];
            return {
                noteName,
                octave,
                midi: roundedMidi,
                cents,
                frequency,
                rawMidi: midiNote
            };
        }
        // è®¡ç®—éŸ³é¢‘RMSéŸ³é‡
        function calculateRMS(buffer) {
            let sum = 0;
            for (let i = 0; i < buffer.length; i++) {
                sum += buffer[i] * buffer[i];
            }
            return Math.sqrt(sum / buffer.length);
        }
        // é¢‘ç‡å¹³æ»‘å¤„ç†ï¼Œå‡å°‘è·³å˜
        function smoothFrequency(frequency) {
            if (!frequency) return null;
            recentFrequencies.push(frequency);
            if (recentFrequencies.length > smoothLevel) {
                recentFrequencies.shift();
            }
            // ä¸­ä½æ•°è¿‡æ»¤å¼‚å¸¸å€¼
            const sorted = [...recentFrequencies].sort((a, b) => a - b);
            const median = sorted[Math.floor(sorted.length / 2)];
            const filtered = recentFrequencies.filter(f => Math.abs(f - median) / median < 0.05);
            if (filtered.length < 2) return frequency;
            // è®¡ç®—å¹³å‡å€¼
            return filtered.reduce((acc, f) => acc + f, 0) / filtered.length;
        }
        // ä¹å™¨é¢„è®¾éŸ³ç¬¦è¿‡æ»¤
        function filterPresetNote(noteInfo) {
            if (!noteInfo || currentPreset === 'all' || currentPreset === 'piano') {
                return noteInfo;
            }
            const allowedMidis = presets[currentPreset];
            if (!allowedMidis) return noteInfo;
            // åŒ¹é…æœ€æ¥è¿‘çš„é¢„è®¾éŸ³ç¬¦
            let closestMidi = allowedMidis[0];
            let minDiff = Math.abs(noteInfo.rawMidi - closestMidi);
            for (const midi of allowedMidis) {
                const diff = Math.abs(noteInfo.rawMidi - midi);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestMidi = midi;
                }
            }
            // è¶…å‡ºèŒƒå›´åˆ™ä¸æ˜¾ç¤º
            if (minDiff > 1.5) return null;
            // é‡æ–°è®¡ç®—éŸ³åˆ†
            const cents = Math.round((noteInfo.rawMidi - closestMidi) * 100);
            const noteIndex = closestMidi % 12;
            const octave = Math.floor(closestMidi / 12) - 1;
            const noteName = noteNames[noteIndex];
            return {
                noteName,
                octave,
                midi: closestMidi,
                cents,
                frequency: noteInfo.frequency,
                rawMidi: noteInfo.rawMidi
            };
        }
        // ä¸»æ£€æµ‹å¾ªç¯
        function detectLoop() {
            if (!isRunning) return;
            const bufferSize = 2048;
            const buffer = new Float32Array(bufferSize);
            const byteBuffer = new Uint8Array(bufferSize);
            // è·å–éŸ³é¢‘æ—¶åŸŸæ•°æ®
            analyser.getFloatTimeDomainData(buffer);
            analyser.getByteTimeDomainData(byteBuffer);
            // è®¡ç®—å¹¶æ›´æ–°éŸ³é‡
            const rms = calculateRMS(buffer);
            const volumePercent = Math.min(100, rms * 1000);
            volumeFill.style.width = `${volumePercent}%`;
            // ç»˜åˆ¶æ³¢å½¢
            drawWaveform(byteBuffer);
            // é™éŸ³æ£€æµ‹ï¼Œä½äºé˜ˆå€¼ä¸è¿›è¡Œæ£€æµ‹
            if (rms < silenceThreshold) {
                noteNameEl.textContent = 'â€”';
                octaveEl.textContent = 'å…«åº¦: â€”';
                centsDisplayEl.textContent = '0éŸ³åˆ†';
                centsDisplayEl.className = 'cents-display';
                noteNameEl.className = 'note-name';
                drawPointer(0);
                animationFrameId = requestAnimationFrame(detectLoop);
                return;
            }
            // éŸ³é«˜æ£€æµ‹ä¸å¤„ç†
            const frequency = yinPitchDetect(buffer, audioContext.sampleRate);
            if (frequency) {
                const smoothedFreq = smoothFrequency(frequency);
                if (smoothedFreq) {
                    let noteInfo = frequencyToNote(smoothedFreq, a4Frequency);
                    noteInfo = filterPresetNote(noteInfo);
                    if (noteInfo) {
                        // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                        noteNameEl.textContent = noteInfo.noteName;
                        octaveEl.textContent = `å…«åº¦: ${noteInfo.octave}`;
                        
                        const cents = noteInfo.cents;
                        const centsText = cents > 0 ? `+${cents}éŸ³åˆ†` : `${cents}éŸ³åˆ†`;
                        centsDisplayEl.textContent = centsText;
                        // æ›´æ–°æ˜¾ç¤ºé¢œè‰²
                        if (Math.abs(cents) <= 5) {
                            noteNameEl.className = 'note-name in-tune';
                            centsDisplayEl.className = 'cents-display in-tune';
                        } else if (cents > 0) {
                            noteNameEl.className = 'note-name';
                            centsDisplayEl.className = 'cents-display plus';
                        } else {
                            noteNameEl.className = 'note-name';
                            centsDisplayEl.className = 'cents-display minus';
                        }
                        // ç»˜åˆ¶æŒ‡é’ˆ
                        drawPointer(cents);
                    }
                }
            }
            animationFrameId = requestAnimationFrame(detectLoop);
        }
        // å¯åŠ¨æ ¡éŸ³æµç¨‹
        async function startTuning() {
            if (isRunning) return;
            try {
                // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                // æ¢å¤æš‚åœçš„ä¸Šä¸‹æ–‡
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                // è·å–éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                mediaStreamSource.connect(analyser);
                // æ›´æ–°çŠ¶æ€
                isRunning = true;
                startBtn.textContent = 'åœæ­¢æ ¡éŸ³';
                startBtn.className = 'primary-btn stop-btn';
                micIndicator.className = 'mic-indicator active';
                micStatusText.textContent = 'å·²å¯åŠ¨';
                recentFrequencies = [];
                // å¯åŠ¨æ£€æµ‹å¾ªç¯
                detectLoop();
                showToast('æ ¡éŸ³å·²å¯åŠ¨', 'success');
            } catch (error) {
                console.error('å¯åŠ¨å¤±è´¥:', error);
                if (error.name === 'NotAllowedError') {
                    showToast('éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¼€å¯æƒé™', 'error');
                } else if (error.name === 'NotFoundError') {
                    showToast('æœªæ‰¾åˆ°å¯ç”¨çš„éº¦å…‹é£è®¾å¤‡', 'error');
                } else {
                    showToast('å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æ˜¯å¦æ­£å¸¸', 'error');
                }
            }
        }
        // åœæ­¢æ ¡éŸ³æµç¨‹
        function stopTuning() {
            if (!isRunning) return;
            isRunning = false;
            // å…³é—­åª’ä½“æµ
            if (mediaStreamSource) {
                mediaStreamSource.disconnect();
                const tracks = mediaStreamSource.mediaStream.getTracks();
                tracks.forEach(track => track.stop());
                mediaStreamSource = null;
            }
            // å–æ¶ˆåŠ¨ç”»å¸§
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            // é‡ç½®ç•Œé¢
            startBtn.textContent = 'å¼€å§‹æ ¡éŸ³';
            startBtn.className = 'primary-btn start-btn';
            micIndicator.className = 'mic-indicator';
            micStatusText.textContent = 'æœªå¯åŠ¨';
            volumeFill.style.width = '0%';
            noteNameEl.textContent = 'â€”';
            octaveEl.textContent = 'å…«åº¦: â€”';
            centsDisplayEl.textContent = '0éŸ³åˆ†';
            centsDisplayEl.className = 'cents-display';
            noteNameEl.className = 'note-name';
            drawPointer(0);
            waveformCtx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            showToast('æ ¡éŸ³å·²åœæ­¢', 'warning');
        }
        // æç¤ºæ¡†æ˜¾ç¤º
        function showToast(message, type = 'error') {
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                themeToggle.checked = false;
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.checked = true;
            }
            initMeter();
        }
        // äº‹ä»¶ç›‘å¬ç»‘å®š
        startBtn.addEventListener('click', () => {
            isRunning ? stopTuning() : startTuning();
        });
        // A4é¢‘ç‡è°ƒæ•´
        a4Slider.addEventListener('input', (e) => {
            a4Frequency = parseFloat(e.target.value);
            a4Input.value = a4Frequency;
        });
        a4Input.addEventListener('input', (e) => {
            let value = parseFloat(e.target.value) || 440;
            value = Math.max(430, Math.min(450, value));
            a4Frequency = value;
            a4Slider.value = value;
            e.target.value = value;
        });
        // ä¹å™¨é¢„è®¾åˆ‡æ¢
        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                presetBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPreset = btn.dataset.preset;
                recentFrequencies = [];
                showToast(`å·²åˆ‡æ¢åˆ°${btn.textContent}é¢„è®¾`, 'success');
            });
        });
        // è®¾ç½®é¢æ¿æ§åˆ¶
        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.add('open');
            overlay.classList.add('open');
        });
        closeSettingsBtn.addEventListener('click', () => {
            settingsPanel.classList.remove('open');
            overlay.classList.remove('open');
        });
        overlay.addEventListener('click', () => {
            settingsPanel.classList.remove('open');
            overlay.classList.remove('open');
        });
        // ä¸»é¢˜åˆ‡æ¢äº‹ä»¶
        themeBtn.addEventListener('click', toggleTheme);
        themeToggle.addEventListener('change', toggleTheme);
        // å¹³æ»‘åº¦è°ƒæ•´
        smoothSlider.addEventListener('input', (e) => {
            smoothLevel = parseInt(e.target.value);
            recentFrequencies = [];
        });
        // ä¿®æ”¹ï¼šé™éŸ³é˜ˆå€¼è°ƒæ•´ï¼Œæ–°å¢å®æ—¶æ˜¾ç¤ºæ›´æ–°é€»è¾‘
        thresholdSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            silenceThreshold = value;
            const db = rmsToDb(value);
            thresholdDisplay.textContent = db === '-âˆ' ? 'è¯†åˆ«æ‰€æœ‰å£°éŸ³' : `å±è”½ä½äº ${db}dB çš„å£°éŸ³`;
        });
        // çª—å£å¤§å°é€‚é…
        window.addEventListener('resize', () => {
            const containerWidth = waveformCanvas.parentElement.clientWidth;
            waveformCanvas.width = containerWidth;
            initMeter();
        });
        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', () => {
            const containerWidth = waveformCanvas.parentElement.clientWidth;
            waveformCanvas.width = containerWidth;
            initMeter();
            // è‡ªåŠ¨é€‚é…ç³»ç»Ÿä¸»é¢˜
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                toggleTheme();
            }
            // æ–°å¢ï¼šåˆå§‹åŒ–é™éŸ³é˜ˆå€¼æ˜¾ç¤º
            const initDb = rmsToDb(parseFloat(thresholdSlider.value));
            thresholdDisplay.textContent = `å±è”½ä½äº ${initDb}dB çš„å£°éŸ³`;
        });
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            stopTuning();
        });
    </script>
</body>
</html>