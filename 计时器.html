<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>è®¡æ—¶å™¨</title>
    <link rel="icon" href="https://user-assets.sxlcdn.com/images/1209238/FlWuslNmGTHt1EipxUtq2GI6zqnN.png?imageMogr2/strip/auto-orient/thumbnail/1200x9000%3E/quality/90!/format/png" type="image/png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: radial-gradient(circle at top, #ff9a9e, #fad0c4 40%, #fbc2eb);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 16px;
        }

        h1 {
            font-size: clamp(32px, 12vw, 56px);
            color: #ffffff;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            letter-spacing: 2px;
            text-align: center;
            line-height: 1.2;
        }

        .timer-container {
            text-align: center;
            background: rgba(0, 0, 0, 0.75);
            border-radius: 32px;
            padding: 32px 20px 36px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.15);
        }

        .mode-switch {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 0;
            border-radius: 60px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            color: #f9f9f9;
            font-size: clamp(16px, 4.5vw, 20px);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .mode-btn.active {
            background: linear-gradient(145deg, #ff6b6b, #ff9f7f);
            border-color: transparent;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
            color: white;
        }

        #showTime {
            font-size: clamp(44px, 15vw, 72px);
            color: #ffffff;
            font-weight: 800;
            margin-bottom: 18px;
            margin-top: 8px;
            letter-spacing: 4px;
            text-shadow: 0 0 18px rgba(255, 255, 255, 0.7);
            transition: color 0.2s, text-shadow 0.2s;
            line-height: 1.2;
        }

        /* è¶…æ—¶çŠ¶æ€é¢œè‰² (é†’ç›®æ©™çº¢) */
        #showTime.overtime {
            color: #ffaa33;
            text-shadow: 0 0 25px #ff8800, 0 0 10px #ff4400;
        }

        .status-text {
            font-size: clamp(13px, 3.5vw, 16px);
            color: #e0e0e0;
            margin-bottom: 18px;
            background: rgba(255,255,255,0.08);
            padding: 8px 16px;
            border-radius: 60px;
            display: inline-block;
        }

        .countdown-settings {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 22px;
            font-size: 15px;
            color: #f1f1f1;
            flex-wrap: wrap;
            background: rgba(0,0,0,0.3);
            border-radius: 60px;
            padding: 12px 16px;
        }

        .countdown-settings label {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 30px;
        }

        .countdown-settings input {
            width: 70px;
            padding: 10px 8px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            outline: none;
            text-align: center;
        }

        .countdown-settings input:focus {
            border-color: #ff9f7f;
            box-shadow: 0 0 12px #ff9f7f;
        }

        .countdown-settings button {
            background: #ff9f7f;
            border: none;
            border-radius: 60px;
            padding: 10px 24px;
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.15s;
            min-width: 80px;
        }

        .btn-row {
            display: flex;
            justify-content: center;
            gap: 18px;
            margin: 20px 0 16px;
        }

        #startBn,
        #restBn {
            min-width: 130px;
            height: 54px;
            padding: 0 20px;
            font-size: clamp(18px, 5vw, 24px);
            font-weight: 600;
            border: none;
            border-radius: 60px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
            letter-spacing: 1px;
        }

        #startBn {
            background: #ff6b6b;
            color: white;
        }

        #restBn {
            background: #4a4a4a;
            color: white;
        }

        #startBn:hover,
        #restBn:hover,
        .countdown-settings button:hover {
            transform: translateY(-2px) scale(1.02);
            filter: brightness(1.1);
        }

        #startBn:active,
        #restBn:active,
        .countdown-settings button:active {
            transform: translateY(2px) scale(0.98);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.5);
        }

        .hidden {
            display: none !important;
        }

        /* æ‰‹æœºå°å±æ—¶æŒ‰é’®æ›´é¥±æ»¡ */
        @media (max-width: 420px) {
            .timer-container {
                padding: 24px 16px;
            }
            .countdown-settings {
                gap: 8px;
            }
            .btn-row {
                gap: 12px;
            }
            #startBn, #restBn {
                min-width: 110px;
                height: 50px;
            }
        }
    </style>
</head>
<body>

    <h1>â±ï¸ è®¡æ—¶å™¨</h1>

    <div class="timer-container">
        <div class="mode-switch">
            <button id="upMode" class="mode-btn active">æ­£è®¡æ—¶</button>
            <button id="downMode" class="mode-btn">å€’è®¡æ—¶</button>
        </div>

        <div id="countdownSettings" class="countdown-settings hidden">
            <label>
                <span>åˆ†</span>
                <input id="minsInput" type="number" min="0" max="599" value="1">
            </label>
            <label>
                <span>ç§’</span>
                <input id="secsInput" type="number" min="0" max="59" value="0">
            </label>
            <button id="setCountdown">è®¾ç½®</button>
        </div>

        <div id="showTime">00:00:00</div>
        <div class="status-text" id="statusText">âš« å½“å‰æ¨¡å¼ï¼šæ­£è®¡æ—¶</div>

        <div class="btn-row">
            <button id="startBn">å¯åŠ¨</button>
            <button id="restBn">å¤ä½</button>
        </div>
    </div>

    <script>
        (function() {
            // ---------- DOM å…ƒç´  ----------
            var showTime = document.getElementById("showTime");
            var startBn = document.getElementById("startBn");
            var restBn = document.getElementById("restBn");
            var upModeBtn = document.getElementById("upMode");
            var downModeBtn = document.getElementById("downMode");
            var countdownSettings = document.getElementById("countdownSettings");
            var minsInput = document.getElementById("minsInput");
            var secsInput = document.getElementById("secsInput");
            var setCountdownBtn = document.getElementById("setCountdown");
            var statusText = document.getElementById("statusText");

            // ---------- æ ¸å¿ƒå˜é‡ ----------
            var bool = false;               // æ˜¯å¦æ­£åœ¨è¿è¡Œ
            var pauseTime = 0;               // ç´¯è®¡æš‚åœæ—¶é—´
            var pauseDate = null;             // æš‚åœå¼€å§‹æ—¶é—´æˆ³
            var mode = 'up';                  // 'up' æ­£è®¡æ—¶, 'down' å€’è®¡æ—¶
            var totalCountdown = 60 * 1000;    // å€’è®¡æ—¶æ€»æ¯«ç§’ (é»˜è®¤1åˆ†é’Ÿ)
            var initCountdown = 60 * 1000;     // è®¾å®šçš„å€’è®¡æ—¶åˆå§‹å€¼

            // ------- è¶…æ—¶ç›¸å…³ -------
            var overtimeActive = false;       // æ˜¯å¦å¤„äºè¶…æ—¶çŠ¶æ€ (å€’è®¡æ—¶å½’é›¶åçš„æ­£è®¡æ—¶)
            var overtimeNotified = false;     // ç¡®ä¿ç»“æŸæ—¶åªé€šçŸ¥/å“é“ƒä¸€æ¬¡

            // ------- å£°éŸ³é˜²é‡ -------
            var lastPlayedSecond = -1;         // ä¸Šä¸€æ¬¡æ’­æ”¾æç¤ºéŸ³çš„ç§’æ•° (ç”¨äºæœ€å5ç§’)

            // ------- éŸ³é¢‘ä¸Šä¸‹æ–‡ (å•ä¾‹) -------
            var audioCtx = null;

            // ------- é€šçŸ¥æƒé™è¯·æ±‚ -------
            if (window.Notification && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                Notification.requestPermission();
            }

            // ---------- åˆå§‹åŒ–äº‹ä»¶ ----------
            startBn.addEventListener("click", clickHandler);
            restBn.addEventListener("click", clickHandler);
            upModeBtn.addEventListener("click", function() { setMode('up'); });
            downModeBtn.addEventListener("click", function() { setMode('down'); });
            setCountdownBtn.addEventListener("click", applyCountdown);

            // é¢„çƒ­éŸ³é¢‘ (ç”¨æˆ·æ‰‹åŠ¿æ—¶åˆ›å»ºå¹¶æŒ‚èµ·ï¼Œæé«˜å…¼å®¹æ€§)
            function initAudio() {
                if (audioCtx) return;
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log("Web Audio ä¸æ”¯æŒ");
                }
            }

            // æ’­æ”¾çŸ­éŸ³ (é¢‘ç‡ã€æ—¶é•¿ã€éŸ³é‡)
            function playBeep(freq, durationSec, volume) {
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        return;
                    }
                }

                var playSound = function() {
                    if (!audioCtx) return;
                    var osc = audioCtx.createOscillator();
                    var gain = audioCtx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = freq || 800;
                    gain.gain.value = volume || 0.2;
                    osc.connect(gain).connect(audioCtx.destination);
                    osc.start();
                    osc.stop(audioCtx.currentTime + (durationSec || 0.1));
                };

                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(playSound).catch(function(e) {});
                } else if (audioCtx.state === 'running') {
                    playSound();
                } else {
                    // closed ä¹‹ç±»é‡æ–°å»º
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    audioCtx.resume().then(playSound).catch(function(e) {});
                }
            }

            // è¿ç»­æ’­æ”¾5å£° (å€’è®¡æ—¶ç»“æŸä¸“ç”¨)  â€”â€” æ¯å£°åŠ é•¿ï¼Œé—´éš”0.7ç§’
            function playFiveBeeps() {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        // æ¯å£°æŒç»­0.3ç§’ï¼Œé¢‘ç‡880Hzï¼ŒéŸ³é‡é€‚ä¸­
                        playBeep(880, 0.3, 0.3);
                    }, i * 700); // é—´éš”700ms (0.7ç§’)
                }
            }

            // å‘é€ç³»ç»Ÿé€šçŸ¥
            function sendNotification(title, body) {
                if (!window.Notification) return;
                if (Notification.permission === 'granted') {
                    new Notification(title, { body: body, icon: 'https://user-assets.sxlcdn.com/images/1209238/FlWuslNmGTHt1EipxUtq2GI6zqnN.png?imageMogr2/strip/auto-orient/thumbnail/48x48/quality/90!/format/png' });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(perm => {
                        if (perm === 'granted') {
                            new Notification(title, { body: body, icon: '...' });
                        }
                    });
                }
            }

            // ---------- åˆ·æ–°æ˜¾ç¤º (16mså¾ªç¯) ----------
            setInterval(animation, 16);

            function animation() {
                if (!bool) return;

                var now = new Date().getTime();
                var elapsed = now - time - pauseTime;  // å·²ç»è¿‡æ¯«ç§’ (ä»å¯åŠ¨å¼€å§‹å‡€è®¡æ—¶)

                if (mode === 'up') {
                    // æ­£å¸¸æ­£è®¡æ—¶
                    if (elapsed < 0) elapsed = 0;
                    showTime.innerHTML = formatTime(elapsed);
                    showTime.classList.remove('overtime');
                    if (statusText.innerHTML.includes('è¶…æ—¶')) {
                        statusText.innerHTML = 'âš« å½“å‰æ¨¡å¼ï¼šæ­£è®¡æ—¶';
                    }
                } 
                else {  // mode === 'down'
                    var remaining = totalCountdown - elapsed;

                    // å¤„ç†å€’è®¡æ—¶ç»“æŸ -> è¿›å…¥è¶…æ—¶çŠ¶æ€
                    if (remaining <= 0) {
                        // é¦–æ¬¡è¿›å…¥è¶…æ—¶: æ’­æ”¾ç»“æŸäº”è¿å“+é€šçŸ¥, æ ‡è®°overtimeActive
                        if (!overtimeActive) {
                            overtimeActive = true;
                            // ç¡®ä¿åªè§¦å‘ä¸€æ¬¡é€šçŸ¥å’Œäº”è¿å“
                            if (!overtimeNotified) {
                                overtimeNotified = true;
                                playFiveBeeps();          // ğŸ”” å“é“ƒ5ä¸‹ (åŠ é•¿ç‰ˆï¼Œé—´éš”0.7ç§’)
                                sendNotification('å€’è®¡æ—¶ç»“æŸ', 'å¼€å§‹è¶…æ—¶è®¡æ—¶ â±ï¸');
                            }
                            showTime.classList.add('overtime');
                            statusText.innerHTML = 'â° å½“å‰æ¨¡å¼ï¼šå€’è®¡æ—¶ Â· è¶…æ—¶ä¸­';
                        }

                        // è¶…æ—¶è®¡æ—¶: ç»è¿‡æ—¶é—´ - æ€»å€’è®¡æ—¶æ—¶é•¿
                        var overtimeElapsed = elapsed - totalCountdown;
                        if (overtimeElapsed < 0) overtimeElapsed = 0;
                        showTime.innerHTML = formatTime(overtimeElapsed);
                        // å·²ç»è¶…æ—¶ï¼Œä¸å†å¤„ç†æœ€å5ç§’å£°éŸ³
                    } 
                    else {
                        // æ­£å¸¸å€’è®¡æ—¶æ˜¾ç¤º
                        showTime.innerHTML = formatTime(remaining);
                        showTime.classList.remove('overtime');
                        if (overtimeActive) {
                            overtimeActive = false;       // æ¸…é™¤è¶…æ—¶çŠ¶æ€
                        }

                        // ---------- æœ€å5ç§’æç¤ºéŸ³ (æ¯ç§’ä¸€å“ï¼Œä¿æŒçŸ­ä¿ƒ) ----------
                        var remainingSec = Math.floor(remaining / 1000);   // æ•´ç§’æ•°
                        if (remainingSec <= 5 && remainingSec >= 1) {
                            if (lastPlayedSecond !== remainingSec) {
                                lastPlayedSecond = remainingSec;
                                playBeep(880, 0.12, 0.25);   // çŸ­ä¿ƒâ€œå˜€â€
                            }
                        } else {
                            lastPlayedSecond = -1;   // é‡ç½®ï¼Œä»¥ä¾¿é‡æ–°è¿›å…¥5ç§’èŒƒå›´
                        }
                    }
                }
            }

            // æ ¼å¼åŒ– mm:ss:cs
            function formatTime(ms) {
                if (ms < 0) ms = 0;
                var minutes = Math.floor(ms / 60000);
                var seconds = Math.floor((ms % 60000) / 1000);
                var centiseconds = Math.floor((ms % 1000) / 10);
                return (minutes < 10 ? "0" + minutes : minutes) + ":" +
                       (seconds < 10 ? "0" + seconds : seconds) + ":" +
                       (centiseconds < 10 ? "0" + centiseconds : centiseconds);
            }

            // ---------- åˆ‡æ¢æ¨¡å¼ ----------
            function setMode(newMode) {
                if (mode === newMode) return;
                mode = newMode;

                // åœæ­¢æ‰€æœ‰è®¡æ—¶ï¼Œé‡ç½®çŠ¶æ€
                bool = false;
                startBn.innerHTML = "å¯åŠ¨";
                pauseTime = 0;
                pauseDate = null;
                time = 0;
                overtimeActive = false;
                overtimeNotified = false;   // æ–°æ¨¡å¼é‡ç½®é€šçŸ¥æ ‡è®°
                lastPlayedSecond = -1;
                showTime.classList.remove('overtime');

                if (mode === 'up') {
                    countdownSettings.classList.add('hidden');
                    upModeBtn.classList.add('active');
                    downModeBtn.classList.remove('active');
                    showTime.innerHTML = "00:00:00";
                    statusText.innerHTML = 'âš« å½“å‰æ¨¡å¼ï¼šæ­£è®¡æ—¶';
                } else {
                    countdownSettings.classList.remove('hidden');
                    downModeBtn.classList.add('active');
                    upModeBtn.classList.remove('active');
                    // ç¡®ä¿æœ‰æœ‰æ•ˆçš„å€’è®¡æ—¶å€¼
                    if (!initCountdown || initCountdown <= 0) {
                        initCountdown = 60 * 1000;
                        totalCountdown = initCountdown;
                    } else {
                        totalCountdown = initCountdown;
                    }
                    showTime.innerHTML = formatTime(totalCountdown);
                    statusText.innerHTML = 'âš« å½“å‰æ¨¡å¼ï¼šå€’è®¡æ—¶';
                }
            }

            // ---------- è®¾ç½®å€’è®¡æ—¶æ—¶é•¿ ----------
            function applyCountdown() {
                var mins = parseInt(minsInput.value, 10) || 0;
                var secs = parseInt(secsInput.value, 10) || 0;
                if (mins < 0) mins = 0;
                if (secs < 0) secs = 0;
                if (secs > 59) secs = 59;

                var totalMs = (mins * 60 + secs) * 1000;
                
                // æ–°å¢ï¼šç¦æ­¢è®¾ç½®ä¸º0
                if (totalMs <= 0) {
                    alert("è¯·è¾“å…¥å¤§äº0çš„æ—¶é—´ï¼ˆåˆ†é’Ÿæˆ–ç§’ä¸èƒ½å…¨ä¸º0ï¼‰");
                    return; // ä¸æ›´æ–°å€’è®¡æ—¶
                }

                initCountdown = totalMs;
                totalCountdown = totalMs;

                // å¤ä½è®¡æ—¶çŠ¶æ€
                bool = false;
                startBn.innerHTML = "å¯åŠ¨";
                pauseTime = 0;
                pauseDate = null;
                time = 0;
                overtimeActive = false;
                overtimeNotified = false;
                lastPlayedSecond = -1;
                showTime.classList.remove('overtime');

                showTime.innerHTML = formatTime(totalCountdown);
                statusText.innerHTML = 'âš« å½“å‰æ¨¡å¼ï¼šå€’è®¡æ—¶';
            }

            // ---------- æŒ‰é’®äº‹ä»¶ (å¯åŠ¨/æš‚åœ / å¤ä½) ----------
            function clickHandler(e) {
                var btn = e.target || e.srcElement;

                // ç”¨æˆ·ç‚¹å‡»æ—¶é¢„çƒ­éŸ³é¢‘
                initAudio();

                if (btn === startBn) {
                    bool = !bool;

                    if (bool) {
                        startBn.innerHTML = "æš‚åœ";

                        if (pauseDate) {
                            pauseTime += (new Date().getTime() - pauseDate);
                            pauseDate = null;
                        }

                        if (!time) {
                            time = new Date().getTime();
                        }
                    } else {
                        startBn.innerHTML = "å¯åŠ¨";
                        pauseDate = new Date().getTime();
                    }
                    return;
                }

                if (btn === restBn) {
                    // å¤ä½é€»è¾‘
                    startBn.innerHTML = "å¯åŠ¨";
                    pauseTime = 0;
                    pauseDate = null;
                    bool = false;
                    time = 0;

                    overtimeActive = false;
                    overtimeNotified = false;
                    lastPlayedSecond = -1;
                    showTime.classList.remove('overtime');

                    if (mode === 'up') {
                        showTime.innerHTML = "00:00:00";
                        statusText.innerHTML = 'âš« å½“å‰æ¨¡å¼ï¼šæ­£è®¡æ—¶';
                    } else {
                        totalCountdown = initCountdown;
                        showTime.innerHTML = formatTime(totalCountdown);
                        statusText.innerHTML = 'âš« å½“å‰æ¨¡å¼ï¼šå€’è®¡æ—¶';
                    }
                }
            }

            // å®šä¹‰timeåŸºå‡†å˜é‡
            var time = 0;

            // åˆå§‹åŒ–æ˜¾ç¤º
            setMode('up');

            // è¾“å…¥æ¡†é»˜è®¤å€¼
            minsInput.value = 1;
            secsInput.value = 0;
        })();
    </script>
</body>
</html>